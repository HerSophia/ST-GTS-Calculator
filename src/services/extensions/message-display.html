<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            serif: ['Playfair Display', 'serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            elegant: { bg: '#0f172a', card: 'rgba(30, 41, 59, 0.85)', border: 'rgba(148, 163, 184, 0.2)', text: '#e2e8f0', accent: '#fcd34d', secondary: '#94a3b8' },
            modern: { bg: '#18181b', card: 'rgba(39, 39, 42, 0.9)', border: 'rgba(255, 255, 255, 0.08)', text: '#f4f4f5', accent: '#3b82f6', secondary: '#71717a' },
            terminal: { bg: '#000000', card: '#0a0a0a', border: '#2a2a2a', text: '#00ff00', accent: '#00ff00', secondary: '#666666' },
            cyber: { bg: '#0a0a1a', card: 'rgba(15, 15, 35, 0.95)', border: 'rgba(139, 92, 246, 0.25)', text: '#e0e7ff', accent: '#a78bfa', secondary: '#6366f1' }
          },
          animation: {
            'fade-in': 'fadeIn 0.3s ease-out',
            'slide-down': 'slideDown 0.25s ease-out',
            'glow': 'glow 2s ease-in-out infinite alternate',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideDown: { '0%': { opacity: '0', transform: 'translateY(-8px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
            glow: { '0%': { boxShadow: '0 0 5px var(--glow-color)' }, '100%': { boxShadow: '0 0 20px var(--glow-color)' } },
          }
        }
      }
    }
  </script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { background: transparent; }
    body { -ms-overflow-style: none; scrollbar-width: none; }
    body::-webkit-scrollbar { display: none; }
    .glass { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    
    /* æŠ˜å åŠ¨ç”» */
    .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, opacity 0.2s ease; opacity: 0; }
    .collapsible-content.open { max-height: 2000px; opacity: 1; }
    
    /* ç»ˆç«¯ä¸»é¢˜æ‰«æçº¿ */
    .scanline { background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,0,0.03) 2px, rgba(0,255,0,0.03) 4px); pointer-events: none; }
    
    /* Cyber ä¸»é¢˜å‘å…‰ */
    .cyber-glow { --glow-color: rgba(139, 92, 246, 0.4); animation: glow 2s ease-in-out infinite alternate; }
    
    /* è¿›åº¦æ¡ */
    .progress-bar { height: 4px; border-radius: 2px; overflow: hidden; }
    .progress-fill { height: 100%; transition: width 0.5s ease; }
    
    /* Tab æ ·å¼ */
    .tab-btn { transition: all 0.15s ease; cursor: pointer; user-select: none; }
    .tab-btn:hover { opacity: 0.8; }
    .tab-content { display: none; animation: fadeIn 0.2s ease; }
    .tab-content.active { display: block; }
  </style>
</head>
<body class="p-2">
  <div id="gts-root" class="w-full mx-auto max-w-2xl">
    <div class="text-center py-8 text-gray-500 text-sm">æ­£åœ¨åŠ è½½...</div>
  </div>
  
  <script>
  (function() {
    // ================= çŠ¶æ€ç®¡ç† =================
    var state = {
      theme: localStorage.getItem('gts-theme') || 'modern',
      expandedCards: {},
      expandedSections: {},  // ç”¨äºæŠ˜å /å±•å¼€è¯¦æƒ…åŒºå—
      activeTab: {},
      characters: [],
      scenario: null,
      lastUpdate: 0
    };
    
    // ================= ä¸»é¢˜é…ç½® =================
    var THEMES = {
      modern: {
        name: 'ç°ä»£',
        icon: 'â—‰',
        container: 'font-sans text-modern-text',
        card: 'glass bg-modern-card border border-modern-border rounded-2xl shadow-xl overflow-hidden',
        header: 'px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors',
        headerTitle: 'font-semibold text-base text-white',
        section: 'border-t border-modern-border',
        sectionHeader: 'px-4 py-2 flex items-center justify-between cursor-pointer hover:bg-white/5 text-sm font-medium text-modern-secondary',
        badge: 'px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wide',
        statGrid: 'grid grid-cols-2 sm:grid-cols-4 gap-2 p-3',
        statItem: 'bg-white/5 rounded-xl p-2.5',
        statLabel: 'text-[10px] text-zinc-500 font-medium uppercase tracking-wide',
        statValue: 'text-sm font-semibold text-zinc-100 font-mono mt-0.5',
        tabBar: 'flex gap-1 p-2 bg-black/20',
        tabBtn: 'px-3 py-1.5 rounded-lg text-xs font-medium',
        tabActive: 'bg-white/10 text-white',
        tabInactive: 'text-zinc-500 hover:text-zinc-300',
      },
      elegant: {
        name: 'ä¼˜é›…',
        icon: 'âœ¦',
        container: 'font-serif text-elegant-text',
        card: 'glass bg-elegant-card border border-elegant-border rounded-xl shadow-lg overflow-hidden',
        header: 'px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-black/10 transition-colors border-b border-elegant-border',
        headerTitle: 'font-serif text-lg italic text-white tracking-wide',
        section: 'border-t border-elegant-border/50',
        sectionHeader: 'px-4 py-2 flex items-center justify-between cursor-pointer hover:bg-black/10 text-xs font-sans uppercase tracking-widest text-elegant-secondary',
        badge: 'px-2 py-0.5 rounded text-[10px] font-sans font-medium uppercase tracking-wider border',
        statGrid: 'grid grid-cols-2 sm:grid-cols-4 gap-px bg-elegant-border/30',
        statItem: 'bg-slate-800/60 p-3 text-center',
        statLabel: 'text-[10px] font-sans uppercase tracking-widest text-elegant-secondary',
        statValue: 'text-base font-serif text-white mt-1',
        tabBar: 'flex gap-2 p-3 bg-black/20 border-b border-elegant-border/50',
        tabBtn: 'px-3 py-1 text-xs font-sans uppercase tracking-wider',
        tabActive: 'text-elegant-accent border-b border-elegant-accent',
        tabInactive: 'text-elegant-secondary hover:text-white',
      },
      terminal: {
        name: 'ç»ˆç«¯',
        icon: '>_',
        container: 'font-mono text-terminal-text',
        card: 'bg-terminal-card border border-terminal-border overflow-hidden relative',
        header: 'px-3 py-2 flex items-center justify-between cursor-pointer hover:bg-zinc-900 border-b border-terminal-border',
        headerTitle: 'text-sm uppercase text-terminal-text',
        section: 'border-t border-terminal-border',
        sectionHeader: 'px-3 py-1.5 flex items-center justify-between cursor-pointer hover:bg-zinc-900 text-xs uppercase text-terminal-secondary',
        badge: 'px-1.5 py-0.5 text-[10px] uppercase border border-current',
        statGrid: 'grid grid-cols-2 sm:grid-cols-4',
        statItem: 'p-2 border-r border-b border-terminal-border',
        statLabel: 'text-[10px] uppercase text-terminal-secondary block',
        statValue: 'text-xs text-terminal-accent',
        tabBar: 'flex border-b border-terminal-border',
        tabBtn: 'px-3 py-1.5 text-[10px] uppercase border-r border-terminal-border',
        tabActive: 'bg-terminal-accent/10 text-terminal-accent',
        tabInactive: 'text-terminal-secondary hover:bg-zinc-900',
        scanline: true,
      },
      cyber: {
        name: 'èµ›åš',
        icon: 'â—ˆ',
        container: 'font-sans text-cyber-text',
        card: 'glass bg-cyber-card border border-cyber-border rounded-lg overflow-hidden cyber-glow',
        header: 'px-4 py-3 flex items-center justify-between cursor-pointer hover:bg-purple-500/5 transition-colors',
        headerTitle: 'font-bold text-base text-white',
        section: 'border-t border-cyber-border',
        sectionHeader: 'px-4 py-2 flex items-center justify-between cursor-pointer hover:bg-purple-500/5 text-sm font-medium text-cyber-secondary',
        badge: 'px-2 py-0.5 rounded text-[10px] font-bold uppercase bg-purple-500/20 text-purple-300 border border-purple-500/30',
        statGrid: 'grid grid-cols-2 sm:grid-cols-4 gap-2 p-3',
        statItem: 'bg-purple-500/10 rounded-lg p-2.5 border border-purple-500/10',
        statLabel: 'text-[10px] text-indigo-400 font-medium uppercase',
        statValue: 'text-sm font-bold text-white font-mono mt-0.5',
        tabBar: 'flex gap-1 p-2 bg-purple-900/20',
        tabBtn: 'px-3 py-1.5 rounded text-xs font-medium',
        tabActive: 'bg-purple-500/20 text-purple-300 border border-purple-500/30',
        tabInactive: 'text-indigo-400 hover:text-purple-300',
      }
    };
    
    // ================= å·¥å…·å‡½æ•° =================
    function getApi() {
      try { return parent.GiantessCalc || parent.window.GiantessCalc; } catch(e) { return null; }
    }
    
    function formatLength(meters) {
      if (meters == null || isNaN(meters)) return '-';
      if (meters < 0.000001) return (meters * 1e9).toFixed(1) + ' nm';
      if (meters < 0.001) return (meters * 1e6).toFixed(1) + ' Î¼m';
      if (meters < 0.01) return (meters * 1000).toFixed(2) + ' mm';
      if (meters < 1) return (meters * 100).toFixed(1) + ' cm';
      if (meters < 1000) return meters.toFixed(2) + ' m';
      if (meters < 1000000) return (meters / 1000).toFixed(2) + ' km';
      if (meters < 1e9) return (meters / 1000).toExponential(2) + ' km';
      return (meters / 9.461e15).toFixed(2) + ' å…‰å¹´';
    }
    
    function formatNumber(n) {
      if (n == null) return '-';
      if (n >= 1e8) return (n / 1e8).toFixed(1) + 'äº¿';
      if (n >= 1e4) return (n / 1e4).toFixed(1) + 'ä¸‡';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'k';
      return Math.round(n).toString();
    }
    
    function formatRatio(ratio) {
      if (ratio == null) return '-';
      if (ratio >= 1) {
        if (ratio >= 1e12) return (ratio / 1e12).toFixed(1) + 'ä¸‡äº¿x';
        if (ratio >= 1e8) return (ratio / 1e8).toFixed(1) + 'äº¿x';
        if (ratio >= 1e4) return (ratio / 1e4).toFixed(1) + 'ä¸‡x';
        return ratio.toFixed(1) + 'x';
      } else {
        return '1/' + Math.round(1/ratio);
      }
    }
    
    function getCharType(char) {
      if (char['ç±»å‹'] === 'å·¨å¤§å¨˜' || (char['å€ç‡'] && char['å€ç‡'] > 1)) return 'giantess';
      if (char['ç±»å‹'] === 'å°äºº' || (char['å€ç‡'] && char['å€ç‡'] < 1)) return 'tiny';
      return 'normal';
    }
    
    function getTypeColors(type) {
      return {
        giantess: { badge: 'bg-red-500/15 text-red-300 border-red-500/30', icon: 'â™›', color: 'text-red-400' },
        tiny: { badge: 'bg-cyan-500/15 text-cyan-300 border-cyan-500/30', icon: 'ğŸœ', color: 'text-cyan-400' },
        normal: { badge: 'bg-emerald-500/15 text-emerald-300 border-emerald-500/30', icon: 'ğŸ‘¤', color: 'text-emerald-400' }
      }[type];
    }
    
    function toggleCard(id) {
      state.expandedCards[id] = !state.expandedCards[id];
      render();
    }
    
    function toggleSection(id) {
      state.expandedSections[id] = !state.expandedSections[id];
      render();
    }
    
    function setTab(cardId, tabId) {
      state.activeTab[cardId] = tabId;
      render();
    }
    
    function setTheme(theme) {
      state.theme = theme;
      localStorage.setItem('gts-theme', theme);
      render();
    }
    
    // ================= æ¸²æŸ“ç»„ä»¶ =================
    function renderThemeSwitcher() {
      var t = THEMES[state.theme];
      var buttons = Object.keys(THEMES).map(function(key) {
        var theme = THEMES[key];
        var isActive = key === state.theme;
        return '<button onclick="setTheme(\'' + key + '\')" class="px-2 py-1 rounded text-xs transition-all ' + 
          (isActive ? 'bg-white/20 text-white' : 'text-gray-400 hover:text-white') + '" title="' + theme.name + '">' + 
          theme.icon + '</button>';
      }).join('');
      
      return '<div class="flex items-center justify-center gap-1 mb-3 p-1 rounded-lg bg-black/30">' + buttons + '</div>';
    }
    
    function renderScenarioBar() {
      if (!state.scenario) return '';
      var t = THEMES[state.theme];
      var s = state.scenario;
      
      // åˆ¤æ–­æ˜¯å¦æœ‰è¯¦ç»†ä¿¡æ¯éœ€è¦æ˜¾ç¤º
      var hasDetails = s.å…·ä½“åœ°ç‚¹ || s.åœºæ™¯æ—¶é—´ || s.äººç¾¤çŠ¶æ€ || s.åœºæ™¯åŸå› ;
      
      // æ ¼å¼åŒ–äººç¾¤å¯†åº¦
      var densityText = '';
      if (s.äººç¾¤å¯†åº¦) {
        var d = s.äººç¾¤å¯†åº¦;
        if (d >= 10000) {
          densityText = (d / 10000).toFixed(1) + 'ä¸‡/kmÂ²';
        } else if (d >= 1000) {
          densityText = (d / 1000).toFixed(1) + 'k/kmÂ²';
        } else {
          densityText = d + '/kmÂ²';
        }
      }
      
      var html = '<div class="' + t.card + ' mb-3 overflow-hidden">';
      
      // å¤´éƒ¨ï¼šåœºæ™¯ç±»å‹ + äººç¾¤å¯†åº¦
      html += '<div class="px-4 py-3 flex items-center justify-between">' +
        '<div class="flex items-center gap-3">' +
          '<span class="text-xl">ğŸŒ</span>' +
          '<div>' +
            '<div class="text-[10px] uppercase tracking-wider text-gray-500">å½“å‰åœºæ™¯</div>' +
            '<div class="font-semibold text-white">' + (s.å½“å‰åœºæ™¯ || 'æœªè®¾ç½®') + '</div>' +
          '</div>' +
        '</div>';
      
      // äººç¾¤å¯†åº¦å¾½ç« 
      if (densityText) {
        var isCustom = s.æ˜¯è‡ªå®šä¹‰å¯†åº¦;
        var badgeClass = isCustom 
          ? 'bg-amber-500/20 text-amber-300 border-amber-500/30' 
          : 'bg-blue-500/15 text-blue-300 border-blue-500/30';
        html += '<div class="flex items-center gap-2">' +
          '<div class="px-2 py-1 rounded-lg text-xs font-mono ' + badgeClass + ' border">' +
            '<span class="mr-1">ğŸ‘¥</span>' + densityText +
            (isCustom ? ' <span class="text-[10px] opacity-70">è‡ªå®šä¹‰</span>' : '') +
          '</div>' +
        '</div>';
      }
      html += '</div>';
      
      // è¯¦ç»†ä¿¡æ¯åŒºåŸŸ
      if (hasDetails) {
        html += '<div class="px-4 py-2 bg-black/20 border-t border-white/5 flex flex-wrap gap-x-4 gap-y-1">';
        
        if (s.å…·ä½“åœ°ç‚¹) {
          html += '<div class="flex items-center gap-1.5 text-xs">' +
            '<span class="text-blue-400">ğŸ“</span>' +
            '<span class="text-gray-300">' + s.å…·ä½“åœ°ç‚¹ + '</span>' +
          '</div>';
        }
        if (s.åœºæ™¯æ—¶é—´) {
          html += '<div class="flex items-center gap-1.5 text-xs">' +
            '<span class="text-purple-400">ğŸ•</span>' +
            '<span class="text-gray-300">' + s.åœºæ™¯æ—¶é—´ + '</span>' +
          '</div>';
        }
        if (s.äººç¾¤çŠ¶æ€) {
          html += '<div class="flex items-center gap-1.5 text-xs">' +
            '<span class="text-green-400">ğŸš¶</span>' +
            '<span class="text-gray-300">' + s.äººç¾¤çŠ¶æ€ + '</span>' +
          '</div>';
        }
        if (s.åœºæ™¯åŸå› ) {
          html += '<div class="flex items-center gap-1.5 text-xs text-gray-500 w-full mt-1">' +
            '<span>ğŸ’¡</span>' +
            '<span class="italic">' + s.åœºæ™¯åŸå›  + '</span>' +
          '</div>';
        }
        
        html += '</div>';
      }
      
      html += '</div>';
      return html;
    }
    
    function renderStats(char, t) {
      var calcData = char._è®¡ç®—æ•°æ® || char;
      var stats = [
        { label: 'å½“å‰èº«é«˜', value: calcData.å½“å‰èº«é«˜_æ ¼å¼åŒ– || formatLength(char.å½“å‰èº«é«˜ || char.èº«é«˜) },
        { label: 'åŸèº«é«˜', value: formatLength(char.åŸèº«é«˜ || char.åŸå§‹èº«é«˜) },
        { label: 'å€ç‡', value: formatRatio(calcData.å€ç‡) },
        { label: 'çº§åˆ«', value: calcData.çº§åˆ« || '-' }
      ];
      
      return '<div class="' + t.statGrid + '">' +
        stats.map(function(s) {
          return '<div class="' + t.statItem + '">' +
            '<div class="' + t.statLabel + '">' + s.label + '</div>' +
            '<div class="' + t.statValue + '">' + s.value + '</div>' +
          '</div>';
        }).join('') +
      '</div>';
    }
    
    function renderBodyParts(char, t) {
      var calcData = char._è®¡ç®—æ•°æ®;
      if (!calcData || !calcData.èº«ä½“éƒ¨ä½_æ ¼å¼åŒ–) return '<div class="p-4 text-center text-gray-500 text-sm">æš‚æ— èº«ä½“éƒ¨ä½æ•°æ®</div>';
      
      var parts = calcData.èº«ä½“éƒ¨ä½_æ ¼å¼åŒ–;
      var cardId = 'body-' + char.name;
      var isExpanded = state.expandedSections[cardId];
      
      // é‡è¦æ•°æ®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
      var primaryKeys = ['èº«é«˜', 'è¶³é•¿', 'æ‰‹æŒé•¿', 'ä¹³æˆ¿é«˜åº¦'];
      // æ¬¡è¦æ•°æ®ï¼ˆæŠ˜å ï¼‰
      var secondaryCategories = {
        'ğŸ“ é«˜åº¦': ['çœ¼ç›é«˜åº¦', 'è‚©è†€é«˜åº¦', 'èƒ¸éƒ¨é¡¶ç«¯', 'èƒ¸éƒ¨åº•ç«¯', 'è‚šè„é«˜åº¦', 'è£†éƒ¨é«˜åº¦'],
        'ğŸ¦¶ è¶³éƒ¨': ['è¶³å®½', 'å¤§è„šè¶¾é•¿', 'è„šè¶¾ç¼éš™'],
        'âœ‹ æ‰‹éƒ¨': ['æ‰‹æŒå®½', 'æ‰‹æŒ‡é•¿', 'æŒ‡ç”²å®½åº¦'],
        'ğŸ’— èƒ¸éƒ¨': ['ä¹³æˆ¿å®½åº¦', 'ä¹³æ²Ÿæ·±åº¦', 'ä¹³å¤´ç›´å¾„'],
        'ğŸ‘ è‡€éƒ¨': ['è‡€éƒ¨å®½åº¦', 'è‡€æ²Ÿæ·±åº¦'],
        'ğŸ‘„ å£è…”': ['å˜´å·´å®½åº¦', 'èˆŒå¤´é•¿', 'èˆŒå¤´å®½']
      };
      
      var html = '<div class="p-3 space-y-3">';
      
      // ä¸»è¦æ•°æ®
      html += '<div class="grid grid-cols-2 gap-2">';
      primaryKeys.forEach(function(key) {
        if (parts[key]) {
          html += '<div class="flex justify-between items-center px-3 py-2 bg-white/10 rounded-lg">' +
            '<span class="text-xs text-gray-400">' + key + '</span>' +
            '<span class="text-sm font-mono font-semibold text-white">' + parts[key] + '</span>' +
          '</div>';
        }
      });
      html += '</div>';
      
      // å±•å¼€æŒ‰é’®
      html += '<button onclick="toggleSection(\'' + cardId + '\')" class="w-full py-1.5 text-xs text-gray-500 hover:text-gray-300 flex items-center justify-center gap-1 transition-colors">' +
        '<span>' + (isExpanded ? 'æ”¶èµ·è¯¦æƒ…' : 'å±•å¼€æ›´å¤š') + '</span>' +
        '<span class="transition-transform ' + (isExpanded ? 'rotate-180' : '') + '">â–¼</span>' +
      '</button>';
      
      // æŠ˜å å†…å®¹
      html += '<div class="collapsible-content ' + (isExpanded ? 'open' : '') + '">';
      html += '<div class="space-y-3 pt-2 border-t border-white/10">';
      for (var cat in secondaryCategories) {
        var items = secondaryCategories[cat].filter(function(k) { return parts[k]; });
        if (items.length === 0) continue;
        
        html += '<div>' +
          '<div class="text-[10px] font-medium text-gray-500 mb-1.5 uppercase tracking-wider">' + cat + '</div>' +
          '<div class="grid grid-cols-2 gap-1">';
        items.forEach(function(key) {
          html += '<div class="flex justify-between items-center px-2 py-1 bg-white/5 rounded text-xs">' +
            '<span class="text-gray-500">' + key + '</span>' +
            '<span class="font-mono text-gray-300">' + parts[key] + '</span>' +
          '</div>';
        });
        html += '</div></div>';
      }
      html += '</div></div>';
      
      html += '</div>';
      return html;
    }
    
    function renderWorldView(char, t) {
      var calcData = char._è®¡ç®—æ•°æ®;
      if (!calcData) return '<div class="p-4 text-center text-gray-500 text-sm">æš‚æ— æ•°æ®</div>';
      
      var refs = calcData.çœ¼ä¸­çš„ä¸–ç•Œ_æ ¼å¼åŒ– || calcData.çœ¼ä¸­çš„å·¨å¤§å¨˜_æ ¼å¼åŒ–;
      if (!refs) return '<div class="p-4 text-center text-gray-500 text-sm">æš‚æ— è§†è§’æ•°æ®</div>';
      
      var isTiny = !!calcData.çœ¼ä¸­çš„å·¨å¤§å¨˜_æ ¼å¼åŒ–;
      var cardId = 'world-' + char.name;
      var isExpanded = state.expandedSections[cardId];
      
      // é‡è¦æ•°æ®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰- å·¨å¤§å¨˜è§†è§’å’Œå°äººè§†è§’ä¸åŒ
      var primaryKeys = isTiny 
        ? ['èº«é«˜', 'è¶³é•¿', 'æ‰‹æŒé•¿']  // å°äººçœ‹å·¨å¤§å¨˜
        : ['æ™®é€šæˆå¹´äºº', 'è½¿è½¦é•¿åº¦', 'åå±‚æ¥¼æˆ¿'];  // å·¨å¤§å¨˜çœ‹ä¸–ç•Œ
      
      // æ¬¡è¦æ•°æ®ï¼ˆæŠ˜å ï¼‰
      var secondaryCategories = isTiny ? {
        'ğŸ‘£ èº«ä½“éƒ¨ä½': ['ä¹³æˆ¿é«˜åº¦', 'èˆŒå¤´é•¿', 'çœ¼ç›é«˜åº¦']
      } : {
        'ğŸ‘¥ äººç±»': ['æ™®é€šç”·æ€§', 'æ™®é€šå¥³æ€§', 'å°å­©'],
        'ğŸš— äº¤é€š': ['å…¬äº¤è½¦é•¿åº¦', 'é£æœº_å®¢æœºé•¿'],
        'ğŸ¢ å»ºç­‘': ['å•å±‚æ¥¼é«˜', 'äº”åå±‚å¤§æ¥¼', 'å“ˆåˆ©æ³•å¡”'],
        'ğŸŒ åœ°ç†': ['ç ç©†æœ—ç›å³°', 'äº‘å±‚é«˜åº¦'],
        'ğŸŒ™ å¤©ä½“': ['æœˆçƒç›´å¾„', 'åœ°çƒç›´å¾„', 'å¤ªé˜³ç›´å¾„']
      };
      
      var html = '<div class="p-3 space-y-3">';
      
      // ä¸»è¦æ•°æ®
      html += '<div class="space-y-1.5">';
      primaryKeys.forEach(function(key) {
        if (refs[key]) {
          html += '<div class="flex justify-between items-center px-3 py-2 bg-white/10 rounded-lg">' +
            '<span class="text-xs text-gray-400">' + key + '</span>' +
            '<span class="text-sm font-mono font-semibold text-white">' + refs[key] + '</span>' +
          '</div>';
        }
      });
      html += '</div>';
      
      // å±•å¼€æŒ‰é’®
      html += '<button onclick="toggleSection(\'' + cardId + '\')" class="w-full py-1.5 text-xs text-gray-500 hover:text-gray-300 flex items-center justify-center gap-1 transition-colors">' +
        '<span>' + (isExpanded ? 'æ”¶èµ·è¯¦æƒ…' : 'å±•å¼€æ›´å¤š') + '</span>' +
        '<span class="transition-transform ' + (isExpanded ? 'rotate-180' : '') + '">â–¼</span>' +
      '</button>';
      
      // æŠ˜å å†…å®¹
      html += '<div class="collapsible-content ' + (isExpanded ? 'open' : '') + '">';
      html += '<div class="space-y-3 pt-2 border-t border-white/10">';
      for (var cat in secondaryCategories) {
        var items = secondaryCategories[cat].filter(function(k) { return refs[k]; });
        if (items.length === 0) continue;
        
        html += '<div>' +
          '<div class="text-[10px] font-medium text-gray-500 mb-1.5 uppercase tracking-wider">' + cat + '</div>' +
          '<div class="space-y-1">';
        items.forEach(function(key) {
          html += '<div class="flex justify-between items-center px-2 py-1 bg-white/5 rounded text-xs">' +
            '<span class="text-gray-500">' + key + '</span>' +
            '<span class="font-mono text-gray-300">' + refs[key] + '</span>' +
          '</div>';
        });
        html += '</div></div>';
      }
      html += '</div></div>';
      
      html += '</div>';
      return html;
    }
    
    function renderDamage(char, t) {
      var damage = char.é¢„ä¼°æŸå®³;
      var actual = char.å®é™…æŸå®³;
      if (!damage && !actual) return '<div class="p-4 text-center text-gray-500 text-sm">æš‚æ— æŸå®³æ•°æ®</div>';
      
      var html = '<div class="p-3 space-y-3">';
      
      if (damage) {
        html += '<div class="p-3 bg-red-500/10 rounded-lg border border-red-500/20">' +
          '<div class="text-[10px] uppercase tracking-wider text-red-400 mb-2 font-medium">é¢„ä¼°æŸå®³</div>' +
          '<div class="grid grid-cols-2 gap-2">' +
            '<div><div class="text-[10px] text-gray-500">ç ´ååŠ›ç­‰çº§</div><div class="text-sm font-bold text-red-300">' + (damage.ç ´ååŠ›ç­‰çº§ || '-') + '</div></div>' +
            '<div><div class="text-[10px] text-gray-500">å•æ­¥ä¼¤äº¡</div><div class="text-sm font-bold text-red-300">' + (damage.å•æ­¥ä¼¤äº¡ || '-') + '</div></div>' +
            '<div class="col-span-2"><div class="text-[10px] text-gray-500">å½“å‰åœºæ™¯</div><div class="text-sm text-gray-300">' + (damage.åœºæ™¯ || '-') + '</div></div>' +
          '</div>' +
        '</div>';
      }
      
      if (actual) {
        html += '<div class="p-3 bg-yellow-500/10 rounded-lg border border-yellow-500/20">' +
          '<div class="text-[10px] uppercase tracking-wider text-yellow-400 mb-2 font-medium">å®é™…æŸå®³è®°å½•</div>' +
          '<div class="grid grid-cols-2 gap-2">' +
            '<div><div class="text-[10px] text-gray-500">æ€»ä¼¤äº¡äººæ•°</div><div class="text-sm font-bold text-yellow-300">' + (actual.æ€»ä¼¤äº¡äººæ•°_æ ¼å¼åŒ– || '-') + '</div></div>' +
            '<div><div class="text-[10px] text-gray-500">å»ºç­‘æŸæ¯</div><div class="text-sm font-bold text-yellow-300">' + (actual.æ€»å»ºç­‘æŸæ¯ ? actual.æ€»å»ºç­‘æŸæ¯ + 'æ ‹' : '-') + '</div></div>' +
            (actual.æœ€è¿‘è¡ŒåŠ¨ ? '<div class="col-span-2"><div class="text-[10px] text-gray-500">æœ€è¿‘è¡ŒåŠ¨</div><div class="text-sm text-gray-300">' + actual.æœ€è¿‘è¡ŒåŠ¨ + '</div></div>' : '') +
          '</div>' +
        '</div>';
      }
      
      html += '</div>';
      return html;
    }
    
    function renderHistory(char, t) {
      var history = char._èº«é«˜å†å²;
      if (!history || history.length === 0) return '<div class="p-4 text-center text-gray-500 text-sm">æš‚æ— èº«é«˜å˜åŒ–è®°å½•</div>';
      
      var html = '<div class="p-3"><div class="relative pl-4 border-l-2 border-gray-700 space-y-3">';
      history.slice().reverse().slice(0, 10).forEach(function(record, i) {
        var changeIcon = record.å˜åŒ– === 'å¢å¤§' ? 'ğŸ“ˆ' : (record.å˜åŒ– === 'ç¼©å°' ? 'ğŸ“‰' : 'â€¢');
        var changeColor = record.å˜åŒ– === 'å¢å¤§' ? 'text-red-400' : (record.å˜åŒ– === 'ç¼©å°' ? 'text-cyan-400' : 'text-gray-400');
        
        html += '<div class="relative animate-fade-in" style="animation-delay: ' + (i * 50) + 'ms">' +
          '<div class="absolute -left-[21px] w-3 h-3 rounded-full bg-gray-800 border-2 border-gray-600 ' + changeColor + '"></div>' +
          '<div class="bg-white/5 rounded-lg p-2">' +
            '<div class="flex items-center justify-between mb-1">' +
              '<span class="font-mono text-sm text-white">' + (record.èº«é«˜_æ ¼å¼åŒ– || formatLength(record.èº«é«˜)) + '</span>' +
              '<span class="text-[10px] text-gray-500">' + (record.æ—¶é—´ç‚¹ || '') + '</span>' +
            '</div>' +
            (record.åŸå›  ? '<div class="text-xs text-gray-400">' + changeIcon + ' ' + record.åŸå›  + '</div>' : '') +
            (record.å˜åŒ–å€ç‡ ? '<div class="text-[10px] text-gray-500 mt-1">å˜åŒ–: ' + formatRatio(record.å˜åŒ–å€ç‡) + '</div>' : '') +
          '</div>' +
        '</div>';
      });
      html += '</div></div>';
      return html;
    }
    
    function renderCharacterCard(char, index) {
      var t = THEMES[state.theme];
      var type = getCharType(char);
      var colors = getTypeColors(type);
      var cardId = 'card-' + index;
      var isExpanded = state.expandedCards[cardId];
      var activeTab = state.activeTab[cardId] || 'stats';
      
      var tabs = [
        { id: 'stats', label: 'æ•°æ®', icon: 'ğŸ“Š' },
        { id: 'body', label: 'èº«ä½“', icon: 'ğŸ‘¤' },
        { id: 'world', label: 'è§†è§’', icon: 'ğŸ‘ï¸' },
        { id: 'damage', label: 'æŸå®³', icon: 'ğŸ’¥' },
        { id: 'history', label: 'å†å²', icon: 'ğŸ“œ' }
      ];
      
      var tabContent = '';
      switch(activeTab) {
        case 'stats': tabContent = renderStats(char, t); break;
        case 'body': tabContent = renderBodyParts(char, t); break;
        case 'world': tabContent = renderWorldView(char, t); break;
        case 'damage': tabContent = renderDamage(char, t); break;
        case 'history': tabContent = renderHistory(char, t); break;
      }
      
      var badgeText = char.çº§åˆ« || char.ç±»å‹ || (type === 'giantess' ? 'å·¨å¤§å¨˜' : type === 'tiny' ? 'å°äºº' : 'NORMAL');
      
      return '<div class="' + t.card + ' mb-3 animate-fade-in" style="animation-delay: ' + (index * 80) + 'ms">' +
        // å¤´éƒ¨
        '<div class="' + t.header + '" onclick="toggleCard(\'' + cardId + '\')">' +
          '<div class="flex items-center gap-2">' +
            '<span class="text-lg ' + colors.color + '">' + colors.icon + '</span>' +
            '<span class="' + t.headerTitle + '">' + char.name + '</span>' +
          '</div>' +
          '<div class="flex items-center gap-2">' +
            '<span class="' + t.badge + ' ' + colors.badge + '">' + badgeText + '</span>' +
            '<span class="text-gray-500 text-xs transition-transform ' + (isExpanded ? 'rotate-180' : '') + '">â–¼</span>' +
          '</div>' +
        '</div>' +
        
        // åŸºæœ¬æ•°æ®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
        renderStats(char, t) +
        
        // å¯æŠ˜å è¯¦æƒ…
        '<div class="collapsible-content ' + (isExpanded ? 'open' : '') + '">' +
          // Tab æ 
          '<div class="' + t.tabBar + '">' +
            tabs.map(function(tab) {
              return '<button onclick="event.stopPropagation(); setTab(\'' + cardId + '\', \'' + tab.id + '\')" ' +
                'class="' + t.tabBtn + ' tab-btn ' + (activeTab === tab.id ? t.tabActive : t.tabInactive) + '">' +
                tab.icon + ' ' + tab.label +
              '</button>';
            }).join('') +
          '</div>' +
          // Tab å†…å®¹
          '<div class="' + t.section + '">' + tabContent + '</div>' +
        '</div>' +
        
        // ç»ˆç«¯ä¸»é¢˜æ‰«æçº¿
        (t.scanline ? '<div class="scanline absolute inset-0 pointer-events-none"></div>' : '') +
      '</div>';
    }
    
    function renderEmptyState() {
      var t = THEMES[state.theme];
      return '<div class="' + t.card + ' p-8 text-center">' +
        '<div class="text-4xl mb-3 opacity-50">ğŸ“Š</div>' +
        '<div class="text-gray-400 mb-2">ç­‰å¾…è§’è‰²æ•°æ®...</div>' +
        '<div class="text-xs text-gray-600">è¯·åœ¨ä¸–ç•Œä¹¦æˆ–è„šæœ¬ä¸­è®¾ç½®è§’è‰²èº«é«˜</div>' +
      '</div>';
    }
    
    // ================= ä¸»æ¸²æŸ“å‡½æ•° =================
    function render() {
      var root = document.getElementById('gts-root');
      var t = THEMES[state.theme];
      
      root.className = 'w-full mx-auto max-w-2xl ' + t.container;
      
      var html = renderThemeSwitcher();
      html += renderScenarioBar();
      
      if (!state.characters || state.characters.length === 0) {
        html += renderEmptyState();
      } else {
        state.characters.forEach(function(char, i) {
          html += renderCharacterCard(char, i);
        });
      }
      
      // æ›´æ–°æ—¶é—´æˆ³
      html += '<div class="text-center text-[10px] text-gray-600 mt-2">' +
        'æœ€åæ›´æ–°: ' + new Date(state.lastUpdate).toLocaleTimeString() +
      '</div>';
      
      root.innerHTML = html;
    }
    
    // ================= æ•°æ®è·å– =================
    function fetchData() {
      var api = getApi();
      if (!api) {
        setTimeout(fetchData, 200);
        return;
      }
      
      try {
        if (api.debug && api.debug.getMvuInfo) {
          var info = api.debug.getMvuInfo();
          if (info && info.messageVariables) {
            // åˆå¹¶è§’è‰²è¯¦æƒ…å’ŒåŸå§‹æ•°æ®
            var details = info.messageVariables.characterDetails || [];
            var rawData = info.messageVariables.rawData || {};
            
            state.characters = details.map(function(d) {
              var raw = rawData.è§’è‰² ? rawData.è§’è‰²[d.name] : {};
              return Object.assign({}, d, raw);
            });
            
            // è·å–åœºæ™¯æ•°æ®ï¼ˆå®Œæ•´ä¿¡æ¯ï¼‰
            if (info.scenario) {
              state.scenario = {
                å½“å‰åœºæ™¯: info.scenario.current || info.scenario.å½“å‰åœºæ™¯,
                åœºæ™¯åŸå› : info.scenario.reason || info.scenario.åœºæ™¯åŸå› ,
                å…·ä½“åœ°ç‚¹: info.scenario.å…·ä½“åœ°ç‚¹,
                åœºæ™¯æ—¶é—´: info.scenario.åœºæ™¯æ—¶é—´,
                äººç¾¤çŠ¶æ€: info.scenario.äººç¾¤çŠ¶æ€,
                äººç¾¤å¯†åº¦: info.scenario.äººç¾¤å¯†åº¦ || info.scenario.populationDensity,
                æ˜¯è‡ªå®šä¹‰å¯†åº¦: info.scenario.isCustomDensity || (info.scenario.äººç¾¤å¯†åº¦ > 0)
              };
            } else if (rawData._åœºæ™¯) {
              // ä»åŸå§‹æ•°æ®è·å–åœºæ™¯
              var s = rawData._åœºæ™¯;
              state.scenario = {
                å½“å‰åœºæ™¯: s.å½“å‰åœºæ™¯,
                åœºæ™¯åŸå› : s.åœºæ™¯åŸå› ,
                å…·ä½“åœ°ç‚¹: s.å…·ä½“åœ°ç‚¹,
                åœºæ™¯æ—¶é—´: s.åœºæ™¯æ—¶é—´,
                äººç¾¤çŠ¶æ€: s.äººç¾¤çŠ¶æ€,
                äººç¾¤å¯†åº¦: s.äººç¾¤å¯†åº¦,
                æ˜¯è‡ªå®šä¹‰å¯†åº¦: s.äººç¾¤å¯†åº¦ > 0
              };
            }
            
            state.lastUpdate = Date.now();
          }
        }
      } catch(e) {
        console.error('GTS Display Error:', e);
      }
      
      render();
    }
    
    // ================= åˆå§‹åŒ– =================
    window.toggleCard = toggleCard;
    window.toggleSection = toggleSection;
    window.setTab = setTab;
    window.setTheme = setTheme;
    
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fetchData);
    } else {
      fetchData();
    }
    
    // å®šæ—¶åˆ·æ–°ï¼ˆæ¯5ç§’ï¼‰
    setInterval(fetchData, 5000);
  })();
  </script>
</body>
</html>