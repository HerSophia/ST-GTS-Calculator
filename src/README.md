# 巨大娘计算器

> 酒馆助手脚本 - 用于「巨大娘」角色扮演的辅助工具

## 功能介绍

- 🎨 **全新现代化 UI** - 优雅简约的卡片式设计，支持响应式布局与 Font Awesome 图标
- 🔌 **内置 MVU 集成** - 零配置开箱即用，自动处理依赖，无需额外安装
- 🔢 **身体数据计算** - 根据身高自动计算身体各部位尺寸（足长、手掌、胸部等）
- 📐 **相对尺寸参照** - 计算参考物（人、建筑、天体）在巨大娘眼中的相对大小
- 🚫 **互动限制检查** - 判断哪些互动在物理上合理，并提供替代方案
- 💥 **损害计算系统** - 计算巨大娘行动造成的破坏（伤亡、建筑损毁、城市/星球毁灭等）
- 💉 **提示词自动注入** - 将计算数据自动注入到 LLM 提示词中
- 📜 **身高历史记录** - 记录角色身高变化历程
- 🌍 **世界观模板系统** - 支持不同设定下的变化机制（现实物理、玄幻修仙、科幻科技等）
- 🔧 **扩展系统** - 可插拔的功能模块，支持自定义扩展

## 架构概览

项目采用**分层架构**设计，自下而上分为 5 层：

```text
┌─────────────────────────────────────────────────────────────────┐
│                        UI Layer (Vue)                           │
│  Panel.vue → panels/* → features/* → components/*               │
├─────────────────────────────────────────────────────────────────┤
│                      Composables Layer                          │
│  useCalculator, useCharacters, useSettings, useDebug, ...       │
├─────────────────────────────────────────────────────────────────┤
│                       Services Layer                            │
│  calculator/, prompt/, mvu/, extensions/, debug/                │
├─────────────────────────────────────────────────────────────────┤
│                       Stores Layer (Pinia)                      │
│  settings, characters, prompts, worldviews                      │
├─────────────────────────────────────────────────────────────────┤
│                        Core Layer (Pure)                        │
│  calculator, formatter, damage, interactions, constants         │
└─────────────────────────────────────────────────────────────────┘
```

| 层级 | 职责 | 特点 |
| ---- | ---- | ---- |
| **Core** | 纯计算逻辑 | 纯函数，零外部依赖，可独立测试 |
| **Stores** | 状态管理 | 只管理状态，不包含业务逻辑 |
| **Services** | 业务协调 | 协调多个模块完成复杂业务 |
| **Composables** | UI 逻辑 | 封装 Vue 组件的响应式逻辑 |
| **UI** | 视图渲染 | 只负责展示和用户交互 |

## 目录结构

```text
src/
├── types/                          # 类型定义（全局共享）
│   ├── calculator.ts               # 计算相关类型
│   ├── character.ts                # 角色数据类型
│   ├── constants.ts                # 常量类型
│   ├── damage.ts                   # 损害计算类型
│   ├── extension.ts                # 扩展系统类型
│   ├── interactions.ts             # 互动限制类型
│   ├── mvu.ts                      # MVU 集成类型
│   ├── prompt.ts                   # 提示词类型
│   ├── settings.ts                 # 设置类型
│   ├── worldview.ts                # 世界观类型
│   └── index.ts                    # 统一导出
│
├── core/                           # 核心计算（纯函数，零外部依赖）
│   ├── constants.ts                # 常量定义
│   │                               # - BASE_BODY_PARTS 身体部位基准
│   │                               # - REFERENCE_OBJECTS 参照物尺寸
│   │                               # - SIZE_LEVELS / TINY_LEVELS 级别定义
│   ├── calculator.ts               # 计算函数
│   │                               # - calculateGiantessData() 巨大娘数据
│   │                               # - calculateTinyData() 小人数据
│   │                               # - determineLevel() 级别判定
│   ├── formatter.ts                # 格式化函数
│   │                               # - formatLength() 长度格式化
│   │                               # - formatWeight() 重量格式化
│   │                               # - formatVolume() 体积格式化
│   ├── interactions.ts             # 互动限制
│   │                               # - INTERACTION_RULES 互动规则
│   │                               # - checkInteractionLimits() 检查限制
│   │                               # - generateInteractionPrompt() 生成提示
│   ├── damage.ts                   # 损害计算
│   │                               # - POPULATION_DENSITY 人口密度参考
│   │                               # - BUILDING_DENSITY 建筑密度参考
│   │                               # - calculateDamage() 计算损害
│   │                               # - generateDamagePrompt() 生成提示
│   └── index.ts                    # Core 层统一导出
│
├── stores/                         # Pinia 状态管理（薄层）
│   ├── settings.ts                 # 设置状态
│   ├── characters.ts               # 角色状态
│   ├── prompts.ts                  # 提示词模板状态
│   ├── worldviews.ts               # 世界观状态
│   └── index.ts                    # 统一导出
│
├── services/                       # 业务服务（协调层）
│   ├── calculator/                 # 计算服务
│   │   ├── character-calculator.ts # 角色数据计算
│   │   ├── interaction-calculator.ts # 互动限制计算
│   │   └── index.ts
│   ├── prompt/                     # 提示词服务
│   │   ├── builder.ts              # 提示词构建
│   │   ├── injector.ts             # 提示词注入
│   │   └── index.ts
│   ├── mvu/                        # MVU 集成服务
│   │   ├── handler.ts              # 事件处理
│   │   ├── history.ts              # 身高历史管理
│   │   └── index.ts
│   ├── extensions/                 # 扩展系统
│   │   ├── manager.ts              # 扩展管理器
│   │   ├── damage-extension.ts     # 损害计算扩展
│   │   └── index.ts
│   ├── debug/                      # 调试服务
│   │   ├── info-collector.ts       # 信息收集
│   │   ├── test-injector.ts        # 测试注入
│   │   └── index.ts
│   ├── global-api.ts               # 全局 API 暴露
│   └── index.ts
│
├── composables/                    # Vue Composables（UI 逻辑层）
│   ├── useCalculator.ts            # 快速计算逻辑
│   ├── useCharacters.ts            # 角色管理逻辑
│   ├── useSettings.ts              # 设置面板逻辑
│   ├── useWorldview.ts             # 世界观管理逻辑
│   ├── usePrompts.ts               # 提示词管理逻辑
│   ├── useDebug.ts                 # 调试面板逻辑
│   ├── useExtensions.ts            # 扩展系统逻辑
│   └── index.ts                    # 统一导出
│
├── ui/                             # UI 组件层
│   ├── components/                 # 通用原子组件
│   │   ├── GcSwitch.vue            # 开关组件
│   │   ├── GcInput.vue             # 输入框组件
│   │   ├── GcButton.vue            # 按钮组件
│   │   ├── GcBadge.vue             # 徽章组件
│   │   ├── GcCard.vue              # 卡片组件
│   │   ├── GcOverlay.vue           # 覆盖层组件
│   │   └── index.ts
│   ├── panels/                     # 面板组件
│   │   ├── SettingsPanel.vue       # 设置面板
│   │   ├── HelpPanel.vue           # 帮助面板
│   │   ├── WorldviewPanel.vue      # 世界观面板
│   │   ├── PromptsPanel.vue        # 提示词面板
│   │   ├── DebugPanel.vue          # 调试面板
│   │   ├── ExtensionsPanel.vue     # 扩展面板
│   │   └── index.ts
│   ├── features/                   # 功能组件
│   │   ├── QuickCalc.vue           # 快速计算
│   │   ├── CharacterCard.vue       # 角色卡片
│   │   ├── DamageDisplay.vue       # 损害数据展示
│   │   ├── ActualDamage.vue        # 实际损害记录
│   │   └── debug/                  # 调试子组件
│   │       ├── DebugStatusSection.vue
│   │       ├── DebugCharactersSection.vue
│   │       ├── DebugTestSection.vue
│   │       ├── DebugLogsSection.vue
│   │       ├── DebugRawSection.vue
│   │       └── index.ts
│   ├── styles/                     # 样式文件
│   │   ├── variables.css           # CSS 变量
│   │   ├── components.css          # 组件样式
│   │   └── panels.css              # 面板样式
│   ├── Panel.vue                   # 主面板容器
│   ├── Result.vue                  # 计算结果展示
│   └── CharacterList.vue           # 角色列表
│
├── 初始化.ts                       # 初始化流程
│                                   # - 动态加载 Font Awesome
│                                   # - 内置导入 MVU Bundle
│                                   # - 注册事件监听
│
├── 设置界面.ts                     # Vue 挂载
│                                   # - 挂载到 #extensions_settings2
│                                   # - 初始化扩展系统
│                                   # - 页面卸载时清理
│
├── settings.ts                     # 兼容层 - 设置（重导出 stores/settings）
├── characters.ts                   # 兼容层 - 角色（重导出 stores/characters）
├── prompts.ts                      # 兼容层 - 提示词（重导出 stores/prompts）
├── worldviews.ts                   # 兼容层 - 世界观（重导出 stores/worldviews）
├── mvu集成.ts                      # 兼容层 - MVU（重导出 services/mvu）
│
├── version.ts                      # 版本信息和更新日志
└── index.ts                        # 入口文件
```

## 使用方法

### 方法一：快速计算

在设置面板中输入身高和原身高，点击计算按钮即可预览数据。

### 方法二：MVU 集成（推荐）

脚本内置了 MVU 库，无需手动安装。在世界书或提示词中直接使用 MVU 命令设置角色身高：

```javascript
// 设置角色数据
_.set('巨大娘.角色.络络.当前身高', 170)      // 当前身高（米）
_.set('巨大娘.角色.络络.原身高', 1.65)       // 原始身高（米）
_.set('巨大娘.角色.络络.变化原因', '喝下药水') // 可选：变化原因
_.set('巨大娘.角色.络络.变化时间', '第三天')  // 可选：变化时间点
```

脚本会自动：

1. 检测身高变化
2. 计算完整的身体数据
3. 记录身高历史
4. 将数据注入到提示词中

### MVU 变量结构

**注意**：角色数据存储在**楼层变量**（message 类型）中，而非聊天变量。这样每条消息可以有独立的数据快照。

```yaml
# 楼层变量 (type: 'message')
stat_data:
  巨大娘:                    # 变量前缀（可配置）
    _场景:                   # 当前场景设置（影响损害计算）
      当前场景: "大城市"      # LLM 或用户设置的场景
      场景原因: "角色来到市中心" # 可选：为什么在这个场景
    _互动限制:               # 多角色时的互动限制
      络络_小明: {...}
    角色:                    # v3.1.0+ 所有角色数据在此键下
      络络:                  # 角色名
        当前身高: 170          # 当前身高（米）
        原身高: 1.65           # 原始身高
        变化原因: "喝下药水"    # 变化原因
        自定义部位:             # 单独部位的自定义尺寸（可选）
          乳房高度: 28         # 胸部单独放大到 28 米
          足长: 40             # 脚掌单独放大到 40 米
        _计算数据: {...}       # 自动生成的计算结果
        _损害数据: {...}       # 自动生成的损害计算结果
        _身高历史: [...]       # 自动记录的历史
```

### 单独部位变化功能

默认情况下，所有身体部位按照身高倍率等比例缩放。但你可以通过 `自定义部位` 字段为特定部位指定独立的尺寸：

```javascript
// 设置角色整体身高为 170 米（约 103 倍）
_.set('巨大娘.角色.络络.当前身高', 170);
_.set('巨大娘.角色.络络.原身高', 1.65);

// 单独设置胸部尺寸为 28 米（约 200 倍，比整体更大）
_.set('巨大娘.角色.络络.自定义部位.乳房高度', 28);

// 单独设置脚掌为 40 米（约 160 倍）
_.set('巨大娘.角色.络络.自定义部位.足长', 40);
```

**支持的部位名称**：

| 分类     | 部位名称                                                                                   |
| -------- | ------------------------------------------------------------------------------------------ |
| 垂直高度 | 身高、眼睛高度、肩膀高度、胸部顶端、胸部底端、肚脐高度、臀部高度、裆部高度、大腿中部、小腿肚、脚踝高度 |
| 足部     | 足长、足宽、大脚趾长、脚趾缝隙                                                             |
| 手部     | 手掌长、手掌宽、手指长、指尖面积、指甲厚度、指甲宽度                                       |
| 胸部     | 乳房高度、乳房宽度、乳沟深度、乳头直径、单乳重量                                           |
| 臀部     | 臀部宽度、臀沟深度、臀部重量                                                               |
| 腰部     | 腰部宽度、肚脐直径、肚脐深度                                                               |
| 外阴     | 阴阜高度、阴阜宽度、大阴唇长、小阴唇长、阴蒂长、阴道口宽                                   |
| 内部     | 阴道深度_闭合、阴道深度_扩张、阴道容积_闭合、阴道容积_扩张、宫颈长、子宫容积               |
| 毛发     | 头发直径、阴毛直径、阴毛长                                                                 |
| 口腔     | 嘴巴宽度、舌头长、舌头宽                                                                   |

**计算结果中的标记**：

- 自定义尺寸的部位在格式化显示时会带有 ⚡ 标记
- `_计算数据.自定义部位` 记录了所有自定义的部位及其尺寸
- `_计算数据.自定义部位_倍率` 记录了自定义部位相对于原始尺寸的倍率

### 实际损害记录功能

系统自动计算的是**预估损害**（基于场景和尺寸），而**实际损害**需要由 LLM 在剧情中记录：

```javascript
// 记录累计损害
_.set('巨大娘.角色.络络._实际损害.总伤亡人数', 15000);  // 累计伤亡
_.set('巨大娘.角色.络络._实际损害.总建筑损毁', 50);     // 累计损毁建筑
_.set('巨大娘.角色.络络._实际损害.总城市毁灭', 1);      // 累计毁灭城市

// 记录最近一次行动
_.set('巨大娘.角色.络络._实际损害.最近行动', {
  描述: '在市中心踩下一脚',
  伤亡人数: 500,
  建筑损毁: 5,
  时间点: '第三天下午'
});

// 记录重大事件
_.set('巨大娘.角色.络络._实际损害.重大事件', [
  { 描述: '摧毁了东京塔', 伤亡人数: 200, 时间点: '第二天' },
  { 描述: '踩平了一个街区', 伤亡人数: 3000, 时间点: '第三天' }
]);
```

**预估 vs 实际的区别**：

- **预估损害**：系统根据足迹面积和场景人口密度自动计算，显示"每一步可能造成的伤亡"
- **实际损害**：LLM 根据剧情发展记录，显示"实际已经造成的伤亡"

### 场景设置功能

损害计算会根据当前场景的人口密度和建筑密度来估算伤亡和破坏。场景可以通过两种方式设置：

#### 方式一：手动设置（设置面板）

在设置面板的「损害计算」部分选择默认场景。

#### 方式二：LLM 自动设置（推荐）

让 LLM 在剧情发展中自动设置当前场景：

```javascript
// 设置当前场景
_.set('巨大娘._场景.当前场景', '大城市');
_.set('巨大娘._场景.场景原因', '角色来到了市中心');  // 可选
```

**场景优先级**：MVU 变量中设置的场景 > 设置面板中的默认场景

#### 可用场景列表

| 分类     | 场景名称     | 说明                                             |
| -------- | ------------ | ------------------------------------------------ |
| 户外场景 | 荒野         | 无人区、沙漠、深山老林等几乎无人的地方           |
|          | 乡村         | 农村、小村庄、田野等人口稀少的地区               |
|          | 郊区         | 城市边缘的居住区，人口密度较低                   |
|          | 小城市       | 小型城镇、县城等                                 |
|          | 中等城市     | 普通地级市、中等规模城市                         |
|          | 大城市       | 省会城市、大型城市的一般区域                     |
|          | 超大城市中心 | 北上广深、纽约曼哈顿等超大城市的核心区           |
|          | 东京市中心   | 东京都心等极高密度城市区域                       |
|          | 香港         | 香港般的超高密度城市                             |
|          | 马尼拉       | 世界上人口最密集的城市区域之一                   |
| 室内场景 | 住宅内       | 普通家庭住宅内部，约 100 平米住 4 人             |
|          | 公寓楼内     | 密集住宅楼内，如学生宿舍、公寓                   |
|          | 办公楼内     | 工作时间的写字楼、办公室                         |
|          | 体育馆内     | 演唱会、体育比赛等大型集会场所                   |
| 特殊场景 | 巨大娘体内   | 小人进入巨大娘身体内部（体内探索场景）           |

**室内场景说明**：

- 室内场景使用高人口密度（人/平方米）但无建筑损毁
- 适合描写小人在室内被踩踏或巨大娘破坏室内的场景

**巨大娘体内场景说明**：

- 人口密度为 0，不计算外部伤亡
- 适合体内探索、vore 等特殊场景

### 物品系统功能

启用物品系统扩展后，可以让 LLM 管理角色携带的物品。系统会自动计算物品随角色缩放后的尺寸，并分析各种互动的可行性。

#### 添加物品

```javascript
// 添加随身物品（会随角色一起缩放）
_.set('巨大娘.角色.络络._物品.手机', {
  名称: '智能手机',
  原始尺寸: { 长: 0.15, 宽: 0.07, 高: 0.008, 重量: 0.2 },
  类型: '日用品',
  材质: '玻璃',
  随身携带: true
});

// 添加场景物品（保持原始尺寸）
_.set('巨大娘.角色.络络._物品.轿车', {
  名称: '轿车',
  原始尺寸: { 长: 4.5, 宽: 1.8, 高: 1.5, 重量: 1500 },
  类型: '交通工具',
  材质: '金属',
  随身携带: false
});
```

#### 移除物品

```javascript
_.unset('巨大娘.角色.络络._物品.手机');
```

#### 物品类型选项

| 类型 | 说明 |
| ---- | ---- |
| 日用品 | 手机、钥匙、钱包等 |
| 配饰 | 戒指、项链、耳环等 |
| 服装 | 衣服、鞋子等 |
| 食物 | 食物、饮料等 |
| 家具 | 桌椅、床等 |
| 交通工具 | 车、船、飞机等 |
| 建筑 | 房屋、大厦等 |
| 自然物 | 树、石头等 |
| 玩具 | 玩具、模型等 |
| 武器 | 武器类 |
| 工具 | 工具类 |
| 其他 | 其他物品 |

#### 材质选项

| 材质 | 特殊效果 |
| ---- | -------- |
| 金属 | 重量巨大时落地会造成严重冲击 |
| 玻璃 | 巨大尺寸下可能因自重碎裂 |
| 液体 | 量巨大时倾倒会形成洪水 |
| 其他 | 塑料、木材、布料、皮革、橡胶、石材、混凝土、食材 |

#### 互动可能性

系统会自动计算以下互动是否可行：

| 互动 | 判定条件 |
| ---- | -------- |
| 单手握持 | 物品尺寸 ≤ 手掌长度 × 1.5 |
| 双手握持 | 物品尺寸 ≤ 手掌长度 × 3 |
| 指尖捏取 | 物品尺寸 ≤ 手掌长度 × 0.5 |
| 一口吞下 | 物品尺寸 ≤ 嘴巴宽度 × 0.5（仅食物） |
| 穿戴 | 尺寸匹配（仅配饰/服装） |

#### 计算结果示例

物品数据会自动计算并可在提示词中使用：

- **缩放尺寸**：物品在当前倍率下的实际尺寸
- **角色视角**：物品相对于角色身体部位的大小（如「约等于角色的手掌」）
- **普通人视角**：物品相对于普通人的大小（如「约100倍人类身高」）
- **互动可能性**：各种互动是否可行及原因
- **特殊效果**：基于材质和尺寸的物理效应

## 全局 API

脚本会暴露 `window.GiantessCalc` 对象，可在控制台或其他脚本中使用：

```javascript
// 计算巨大娘数据
GiantessCalc.calculate(170, 1.65)

// 计算小人数据
GiantessCalc.calculateTiny(0.017, 1.70)

// 检查互动限制
GiantessCalc.checkInteraction(170, 0.017)

// 格式化长度
GiantessCalc.formatLength(1500)  // "1.5公里"

// 常量
GiantessCalc.BASE_BODY_PARTS     // 身体部位基准
GiantessCalc.REFERENCE_OBJECTS   // 参照物
GiantessCalc.SIZE_LEVELS         // 巨大化级别
GiantessCalc.INTERACTION_RULES   // 互动规则

// 配置（只读）
GiantessCalc.CONFIG              // 当前设置
GiantessCalc.VERSION             // 版本号

// 调试功能
GiantessCalc.debug.getMvuInfo()  // 获取 MVU 状态信息
GiantessCalc.debug.injectTestData('角色名', 100, 1.65)  // 注入巨大娘测试数据
GiantessCalc.debug.injectTestData('小人', 0.01, 1.65)   // 注入小人测试数据
GiantessCalc.debug.clearTestData('角色名')  // 清除指定角色的测试数据
GiantessCalc.debug.clearTestData()   // 清除所有测试数据
GiantessCalc.debug.logs          // 调试日志列表
GiantessCalc.debug.clearLogs()   // 清空调试日志

// 服务访问（v3.0.0 新增）
GiantessCalc.services.calculator  // 计算服务
GiantessCalc.services.prompt      // 提示词服务
GiantessCalc.services.mvu         // MVU 服务
GiantessCalc.services.extensions  // 扩展管理器
```

## 调试模式

启用调试模式后，可以在设置面板中看到一个 🪲 调试按钮，点击打开调试面板。

### 调试面板功能

1. **MVU 状态监控**
   - 查看 MVU 是否可用
   - 查看当前变量前缀
   - 查看是否有 `stat_data` 和巨大娘数据
   - 查看已注册的角色列表

2. **测试数据注入**
   - 快速注入测试角色数据
   - 验证 MVU 数据流是否正常工作
   - 不影响实际聊天数据

3. **调试日志**
   - 实时查看数据处理流程
   - 跟踪变量更新事件
   - 查看计算结果和注入状态

4. **原始数据查看**
   - 查看 MVU 变量的原始 JSON 数据
   - 便于排查数据格式问题

## 扩展系统

v3.0.0 引入了可插拔的扩展系统，支持功能模块的动态启用/禁用。

### 内置扩展

| 扩展 | ID | 说明 | 默认状态 |
| ---- | -- | ---- | -------- |
| 损害计算 | `damage-calculation` | 计算巨大娘行动可能造成的破坏 | 禁用 |

### 扩展 API

```javascript
// 获取扩展管理器
const manager = GiantessCalc.services.extensions;

// 获取所有扩展
manager.getAll();

// 检查扩展是否启用
manager.isEnabled('damage-calculation');

// 启用/禁用扩展
manager.enable('damage-calculation');
manager.disable('damage-calculation');
```

### 扩展生命周期

扩展可以实现以下钩子：

- `onInit()` - 扩展注册时调用
- `onEnable()` - 扩展启用时调用
- `onDisable()` - 扩展禁用时调用
- `onCharacterUpdate(character, calcData)` - 角色数据更新时调用
- `onBeforePromptInject(context)` - 提示词注入前调用
- `onAfterPromptInject(promptId)` - 提示词注入后调用

### 扩展内容贡献

扩展可以贡献：

- 提示词模板（`getPromptTemplates()`）
- 设置组件（`getSettingsComponent()`）
- 角色卡片额外内容（`getCharacterCardExtra()`）
- 调试面板内容（`getDebugPanelExtra()`）

## 配置说明

| 配置项 | 说明 | 默认值 |
| ------ | ---- | ------ |
| `enabled` | 启用脚本 | `true` |
| `variablePrefix` | MVU 变量前缀 | `"巨大娘"` |
| `autoInject` | 自动注入提示词 | `true` |
| `injectDepth` | 注入深度（0=最新消息） | `1` |
| `injectInteractionLimits` | 注入互动限制 | `true` |
| `showVariableUpdateRules` | 显示变量更新规则 | `true` |
| `compactPromptFormat` | 紧凑提示词格式 | `false` |
| `debug` | 调试模式 | `false` |
| `precision` | 数值精度 | `2` |
| `maxHistoryRecords` | 最大历史记录数 | `20` |
| `enableDamageCalculation` | 启用损害计算 | `false` |
| `injectDamagePrompt` | 注入损害提示词 | `true` |
| `damageScenario` | 损害场景 | `"大城市"` |
| `showSpecialEffects` | 显示特殊物理效应 | `true` |
| `showDamagePerCharacter` | 按角色显示损害 | `true` |
| `showDamageSummary` | 显示损害汇总 | `true` |

## 提示词模板系统

提示词模板管理系统允许你自定义注入到 AI 的提示词内容。

### 内置模板

| 模板 | 类型 | 说明 |
| ---- | ---- | ---- |
| 头部说明 | header | 提示词的开头部分 |
| 角色数据 | character | 每个角色的身体数据（为每个角色生成） |
| 互动限制 | interaction | 角色之间的互动限制说明 |
| 变量更新规则 | rules | 指导 AI 如何更新角色数据变量 |
| 世界观设定 | worldview | 当前世界观的变化机制和特殊规则 |
| 写作指南 | footer | 针对巨大娘/小人场景的写作建议（默认禁用） |

### 模板变量

在模板中可以使用以下变量（使用 `{{变量名}}` 格式）：

| 变量 | 说明 |
| ---- | ---- |
| `{{角色名}}` | 角色名称 |
| `{{当前身高}}` | 当前身高（数值，米） |
| `{{当前身高_格式化}}` | 当前身高（格式化字符串） |
| `{{原身高}}` | 原始身高（数值，米） |
| `{{原身高_格式化}}` | 原始身高（格式化字符串） |
| `{{倍率}}` | 变化倍率 |
| `{{级别}}` | 级别名称 |
| `{{描述}}` | 级别描述 |
| `{{身体数据}}` | 格式化的身体部位数据 |
| `{{相对参照}}` | 格式化的相对参照物 |
| `{{互动限制列表}}` | 格式化的互动限制列表 |
| `{{世界观提示词}}` | 当前世界观的完整提示词 |
| `{{世界观名称}}` | 当前世界观名称 |

### 自定义模板

你可以创建自己的自定义模板：

1. 点击设置面板中的 📄 按钮打开提示词管理
2. 点击「新建自定义模板」按钮
3. 填写模板名称、描述、类型和内容
4. 使用上下箭头调整模板顺序
5. 自定义模板可以删除，内置模板只能禁用

**模板数据存储**：所有模板数据存储在**全局变量**中（`giantessCalc_promptTemplates`），因此你的自定义模板会在所有聊天中生效并持久化保存。

### 变量更新规则示例

当 AI 需要更新角色身高时，会按照以下 XML 格式输出（便于后续正则过滤）：

```xml
<gts_update>
_.set('巨大娘.角色.络络.当前身高', 500);
_.set('巨大娘.角色.络络.变化原因', '喝下成长药水');
_.set('巨大娘.角色.络络.变化时间', '第三天傍晚');
</gts_update>
```

## 世界观模板系统

世界观模板系统允许你为角色扮演设定不同的世界观背景，影响巨大化/缩小化的机制和规则。

### 内置世界观

| 世界观 | 图标 | 说明 |
| ------ | ---- | ---- |
| 现实物理 | ⚛️ | 遵循物理定律的硬核设定，身体素质随体型指数增长 |
| 玄幻修仙 | ☯️ | 通过灵气、法术或法宝实现体型变化，不受物理定律约束 |
| 科幻科技 | 🔬 | 通过纳米技术、基因改造或缩放射线等科技手段实现 |
| 魔法少女 | 🪄 | 通过变身魔法实现，通常有华丽的变身过程和时间限制 |
| 怪物娘 | 🐉 | 作为特殊种族天生拥有巨大体型，是种族特性而非后天变化 |
| 超自然 | 👻 | 神力、诅咒、许愿等超自然力量导致的体型变化 |
| 梦境幻想 | 🌙 | 在梦境、幻想空间或精神世界中的体型变化，不受现实约束 |
| 纯粹幻想 | ❤️ | 不考虑设定合理性，专注于场景和感官体验的纯粹描写 |

### 世界观内容

每个世界观包含以下信息：

- **变化机制**：描述体型变化是如何发生的
- **身体特性**：变化后身体有什么特殊特征
- **限制与代价**：使用这种变化方式有什么限制
- **特殊规则**：这个世界观下的特殊互动规则
- **写作建议**：针对这个世界观的写作技巧

### 使用世界观

1. 点击设置面板中的世界观按钮（紫色图标）
2. 在世界观列表中选择想要的世界观
3. 启用「注入世界观提示词」选项
4. 世界观信息会自动注入到 AI 提示词中

### 自定义世界观

你可以创建自己的世界观：

1. 在世界观面板中点击「新建自定义世界观」
2. 填写世界观名称、图标、描述等信息
3. 自定义世界观可以编辑和删除

**世界观数据存储**：所有世界观数据存储在**全局变量**中，跨聊天持久化保存。

## 级别说明

### 巨大化级别

| 级别 | 倍率范围 | 描述 |
| ---- | -------- | ---- |
| Mini级 | 1-10x | 几米到十几米 |
| 十倍 | 10-100x | 建筑如玩具 |
| Kilo级 | 100-1000x | 城市踩在脚下 |
| 千倍 | 1000-10000x | 山脉如石子 |
| Mega级 | 1万-100万x | 触及云层到行星尺度 |
| Giga级 | 100万-10亿x | 星球如玩具 |
| Tera级 | 10亿-万亿x | 恒星系穿行 |
| 宇宙级 | >万亿x | 超越可观测宇宙 |

### 缩小级别

| 级别 | 倍率 | 描述 |
| ---- | ---- | ---- |
| 十分之一 | 0.1x | 如宠物 |
| 百分之一 | 0.01x | 如虫子 |
| 毫米级 | 0.001x | 蚂蚁如猛兽 |
| 微米级 | 0.000001x | 细胞尺度 |
| 纳米级 | 0.000000001x | 分子尺度 |

## 技术栈

- **Vue 3** - 组件化 UI
- **Pinia** - 状态管理
- **TypeScript** - 类型安全
- **Font Awesome** - 矢量图标库
- **酒馆助手 API** - MVU 变量、提示词注入

## 版本

当前版本：**v3.0.0**

### v3.0.0 - 架构重构

这是一个重大的架构重构版本，采用分层架构设计，提升代码可维护性和可扩展性。

**架构改进**：

- 📐 **分层架构** - 清晰的 5 层架构（Core → Stores → Services → Composables → UI）
- 🔧 **扩展系统** - 可插拔的功能模块，支持自定义扩展
- 📦 **类型系统** - 完整的 TypeScript 类型定义，统一在 `types/` 目录
- 🔌 **服务层** - 业务逻辑解耦到独立的服务模块
- 🎨 **组件拆分** - Panel.vue 从 3300 行拆分为多个小组件（<400 行）

**重构统计**：

| 文件 | 重构前 | 重构后 | 改善 |
| ---- | ------ | ------ | ---- |
| mvu集成.ts | 1022 行 | ~21 行（薄入口层） | -98% |
| Panel.vue | 3342 行 | ~565 行 | -83% |
| 最大单文件 | 3342 行 | <400 行 | -88% |

**新增功能**：

- 扩展系统 UI 面板
- 服务 API 访问（`GiantessCalc.services.*`）
- 完整的扩展生命周期钩子
- 损害计算作为可选扩展

**向后兼容**：

- ✅ 全局 API `window.GiantessCalc` 完全兼容
- ✅ MVU 变量结构不变
- ✅ 设置自动迁移
- ✅ 原导入路径通过兼容层保持可用

### 历史版本

**v2.6.0**

- 新增：**损害计算系统** - 计算巨大娘行动造成的破坏
  - 人员伤亡估算（支持10种人口密度场景）
  - 建筑损毁数量计算
  - 街道/城区毁坏估算
  - 宏观破坏力（城市/国家/大陆/行星/恒星/星系/宇宙级）
  - 特殊物理效应（地震、海啸、引力场等）
- 新增：**扩展系统控制面板** - 在角色列表下方统一管理计算模块
  - 基础计算系统（始终开启）
  - 损害计算系统（可开关）
- 新增：按角色显示损害数据和多角色汇总统计
- 新增：损害提示词模板，支持自动注入到 AI 提示词
- 新增：角色卡片展示损害数据详情（破坏力等级、足迹、伤亡、特殊效应）
- 新增：`calculateDamage()` 函数和 `generateDamagePrompt()` 函数
- 新增：6个新设置项控制损害计算功能
- 新增：10种人口密度场景（荒野到马尼拉）

**v2.5.0**

- 新增：**单独部位变化功能** - 可为特定部位设置独立尺寸（如胸部、脚掌等）
- 新增：`自定义部位` 字段支持，允许部位有不同于整体的变化倍率
- 新增：自定义部位在输出中带有 ⚡ 标记，便于识别
- 新增：提示词模板支持 `{{自定义部位}}` 变量
- 更新：变量更新规则增加单独部位设置说明

**v2.4.0**

- 新增：世界观模板系统，支持不同设定下的变化机制
- 新增：8种内置世界观（现实物理、玄幻修仙、科幻科技、魔法少女等）
- 新增：世界观快速切换器和详情展示面板
- 新增：自定义世界观创建和编辑功能
- 新增：世界观提示词自动注入到 AI 提示词
- 优化：提示词模板系统增加世界观类型支持
