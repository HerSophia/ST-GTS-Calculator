name: bundle

on:
  push:
    branches:
      - main
    paths-ignore:
      - dist/**
      - json/**
      - '**.md'
      - 'docs/**'
  workflow_dispatch:

permissions:
  actions: read
  contents: write

concurrency:
  group: ${{ github.workflow }}

jobs:
  # å…ˆè¿è¡Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Run ESLint
        run: pnpm lint

      - name: Run unit tests
        run: pnpm test:run

  # æµ‹è¯•é€šè¿‡åæ„å»ºå’Œå‘å¸ƒ
  bundle:
    runs-on: ubuntu-latest
    needs: test
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      json_file: ${{ steps.get_version.outputs.json_file }}
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install

      - name: Build and inject to JSON
        run: pnpm build:inject

      - name: Get version info
        id: get_version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          JSON_FILE="GTS-Calculator-v${VERSION}.json"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "json_file=${JSON_FILE}" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: ${VERSION}"
          echo "ğŸ“„ JSON File: ${JSON_FILE}"

      - name: Force add dist and json (ignored by .gitignore)
        run: |
          git add -f dist/
          git add -f json/

      - name: Commit changes
        uses: EndBug/add-and-commit@v9.1.3
        with:
          default_author: github_actions
          message: '[bot] build: æ›´æ–°æ„å»ºäº§ç‰© v${{ steps.get_version.outputs.version }}'

      - name: Create or Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: å·¨å¤§å¨˜è®¡ç®—å™¨ v${{ steps.get_version.outputs.version }}
          body: |
            ## ğŸ“¦ å®‰è£…æ–¹æ³•
            
            1. ä¸‹è½½ä¸‹æ–¹çš„ `${{ steps.get_version.outputs.json_file }}` æ–‡ä»¶
            2. åœ¨ SillyTavern ä¸­æ‰“å¼€ **æ‰©å±•** â†’ **é…’é¦†åŠ©æ‰‹** â†’ **è„šæœ¬åº“**
            3. ç‚¹å‡» **å¯¼å…¥è„šæœ¬**ï¼Œé€‰æ‹©ä¸‹è½½çš„ JSON æ–‡ä»¶
            4. é€‰æ‹© **å…¨å±€è„šæœ¬**ï¼Œå¯¼å…¥å¹¶å¯ç”¨
            
            ## ğŸ“‹ æ›´æ–°æ—¥å¿—
            
            è¯·æŸ¥çœ‹ [README](https://github.com/${{ github.repository }}#readme) äº†è§£å®Œæ•´æ›´æ–°æ—¥å¿—ã€‚
          files: |
            json/${{ steps.get_version.outputs.json_file }}
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
